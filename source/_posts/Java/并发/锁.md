title: 锁
categories:
  - Java
  - 并发
description: Java中的锁
author: Jade
date: 2020-07-23 16:01:00
---
## 锁
在计算机科学中，锁于互斥时一种同步机制，用于在有许多执行线程的环境中强制对资源的访问限制。

## 乐观锁与悲观锁
乐观锁与悲观锁是一种广义上的概念，体现了看待线程同步的不同角度。
### 悲观锁
对于同一个数据的并发操作，悲观锁认为自己在使用数据的时候一定有别的线程来修改数据，因此在获取数据的时候会先加锁，确保数据不会被别的线程修改。  
在Java中，synchronized关键字和Lock的实现类都是悲观锁。
### 乐观锁
对于同一个数据的并发操作，乐观锁认为自己在使用数据的时候不会有别的线程修改数据，所以不会加锁，只是在更新数据的时候去判断之前有没有别的线程更新乐这个数据。  
乐观锁在Java中是通过无锁编程来实现，最常采用的是CAS算法。
### 使用场景
- 乐观锁多用在读多写少的情况下。
- 悲观锁多用在读少写多的情况下。

## 自旋锁
### 提出
阻塞或唤醒一个Java线程需要操作系统切换CPU状态来完成，这种状态转换需要耗费处理器时间。如果同步代码块中的内容过于简单，状态转换消耗的时间有可能比用户代码执行的时间还要长。
### 定义
当一个线程尝试去获取某一把锁的时候，如果这个锁此时已经被别的线程占用，那么此线程就无法获取到这把锁，该线程会等待，间隔一段时间后会再次尝试获取。这种采用循环加锁 -> 等待的机制被称为自旋锁（spinlock）。
### 适应性自旋锁
自旋的时间不再固定，而是由前一次在同一个锁上的自旋时间及锁的拥有者的状态来决定。

## 无锁、偏向锁、轻量级锁、重量级锁

## 公平锁、非公平锁
### 公平锁
指多个线程按照申请锁的顺寻来获取锁，线程直接进入队列中排队，队列的第一个线程才能获取锁。
#### 优点
等待锁的线程不会饿死。
#### 缺点
整体吞吐效率相对非公平锁低，CPU唤醒阻塞线程的开销比非公平锁大。
### 非公平锁
指多个线程加锁时直接尝试获取锁，获取不到才会到等待队列的队尾排队。
#### 优点
减少唤起线程的开销，整体的吞吐量高。
#### 缺点
处于等待队列中的线程可能会饿死。

## 可重入锁、非可重入锁
### 可重入锁
又名递归锁，是指在同一个线程在外层方法获取锁的时候，在进入该线程的内层方法会自动获取锁。（前提是锁对象得是同一个对象或者class。）
#### 优点
可一定程度上避免死锁。

## 独享锁、共享锁
### 独享锁
也叫排他锁、互斥锁，指该锁一次只能被一个线程所持有，获得该锁的线程既能读数据也能写数据。
### 共享锁
该锁可被多个线程共享，获得共享锁的线程只能读数据，不能写数据。一个线程对某数据加了共享锁后，其它线程只能添加共享锁，不能加独享锁。

