title: 类加载
categories:
  - Java
  - JVM
description: 类加载
author: Jade
date: 2021-12-16 17:00:00
---

## 类的声明周期
加载 -> 连接（验证 -> 准备 -> 解析） -> 初始化 -> 使用 -> 卸载。
类型的加载、连接、初始化过程都是在程序运行期间完成的。

## 类加载
加载、连接、初始化 三个阶段是连续完成的，所以合成为类加载或类初始化。

## 各阶段功能
### 加载
将class文件加载进方法区，在堆上创建class对象。class对象拥有访问方法区中数据的接口。
加载来源：
- 从本地系统中直接加载。
- 从网络上下载.class文件
- 从zip、jar等归档文件中加载.class文件。
- 从专用数据库提取.class文件。
- 将java源文件动态编译为.class文件。

### 验证
文件格式验证、元数据验证、字节码验证、符号引用验证。
不是必须的，可通过 -Xverifynone 关闭验证。

### 准备
为static变量分配内存，并初始化为该数据类型的默认值。
如果是final修饰的字面量，则初始化为指定值。并放入常量池。

### 解析
将符号引用替换为直接引用。
为了支持动态绑定，可以在初始化之后在解析。

### 初始化
一般来说，当对类的是首次主动使用的时候才会导致类的初始化。
初始化阶段对static变量赋予指定值。
主动使用情况：
- new创建对象实例。
- 访问static变量或赋值。（在编译期把结果放入常量池的 static final 字段除外。）
- 调用static或方法。
- 反射，如Class.forName()。
- 初始化子类，父类也会被初始化。
- Java虚拟机启动时被标明为启动类的类、Main方法所在的类。

### 声明周期结束
- 执行了System.exit()方法。
- 程序正常执行结束。
- 程序在执行过程中遇到了异常或错误而异常终止。
- 由于操作系统出现错误而导致Java虚拟机进程终止。

## 接口的加载
类加载会首先初始化其父类，但是接口只初始化自身，父接口只有用到时才去初始化。

## Q
对于子类直接访问父类static变量的情况，会初始化父类，但不会初始化子类。
子类直接访问父类static变量，导致父类初始化，说明子类知道这个变量是父类的，即子类的数据已被加载。那就是说子类加载了，但是没有初始化。所以在这种情况下， 加载、连接、初始化 就不是连续进行的了？？？

## 预加载与按需加载
Java运行所需要的基本类采用预加载方式，JRE运行时全部加载到内存中。
程序中需要使用的自定义类使用按需加载，需要用到的时候再加载。减少内存消耗。

## 类加载器
### 机制
- 委托：加载一个类的请求西安交给父类加载器，如果父类加载器找不到或不能加载时，再有子类加载器加载。
- 可见性：子类的加载器可以看见父类加载器加载的类，而父类加载器看不到子类加载器加载的类。
- 单一性：一个类只被加载一次。

### 分类
- 引导类加载器
- 扩展类加载器
- 应用类加载器
- 自定义类加载器： 扩展java虚拟机动态加载类的机制。如加密字节码解密。

## 加载方式
- 隐式加载/静态加载 new、static、子类。
- 显示加载/动态加载 Class.forName()、 ClassLoader.loadClass()。
